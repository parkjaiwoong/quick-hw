# 고객 계좌/카드 연동 가이드 (운영 측 준비 사항)

## 현재 플로우
- 고객이 **기사 연결 요청** 시 결제 수단(카드/계좌이체/현금)을 선택합니다.
- 카드 선택 시 배송 생성 후 **결제 페이지**(`/customer/delivery/[id]/pay`)로 이동해 토스페이먼츠 **일회성 결제**를 진행합니다.
- **계좌 연동** 화면: `/customer/account-link` (새 배송 요청 폼의 "계좌/카드 연동" 링크로 이동)

## 계좌 연동 시 운영(개발) 측에서 할 일

### 1. 토스페이먼츠 빌링키(자동결제) 연동
- [토스페이먼츠 빌링키 발급](https://docs.tosspayments.com/guides/v2/billing/overview) API를 사용해 고객이 카드를 한 번 등록하면, 이후 결제 시 카드 입력 없이 결제할 수 있게 합니다.
- 필요한 작업:
  - 빌링키 발급용 **고객 키(customerKey)** 생성·저장 (예: `profiles.id` 또는 전용 테이블)
  - **빌링키 발급** API 호출 후 발급된 `billingKey`를 DB에 저장 (예: `customer_billing_keys` 테이블)
  - 기사 연결 요청 후 결제 시 **빌링키로 결제** API 호출 (일회성 결제 대신)

### 2. DB/백엔드
- 빌링키 저장용 테이블 예시:
  - `customer_billing_keys (user_id, billing_key, pg_provider, created_at)` 등
- RLS: 본인만 자신의 빌링키 조회/삭제 가능하도록 정책 설정

### 3. 프론트/화면
- `/customer/account-link` 페이지에서:
  - “카드 등록” 버튼 클릭 → 토스 빌링키 발급 창 띄우기 → 성공 시 `billingKey` 서버로 전달해 저장
  - 이미 등록된 카드가 있으면 “등록된 카드로 결제” 옵션 노출
- 배송 요청 시: “등록된 카드로 결제” 선택 시 결제 페이지에서 빌링키 결제 API 호출

### 4. 계좌이체 연동 (선택)
- 계좌이체는 토스 **출금 동의** + **예치금** 등 별도 플로우가 필요할 수 있습니다.
- [토스페이먼츠 출금](https://docs.tosspayments.com/guides/v2/transfer/overview) 문서 확인 후, 필요 시 출금 동의·예치금 충전 플로우 구현

### 5. 환경 변수
- 이미 사용 중: `TOSS_CLIENT_KEY`, `TOSS_SECRET_KEY` (일회성 결제용)
- 빌링키/자동결제용 추가 설정은 토스 개발자센터에서 확인

## 화면 경로 점검
| 화면 | 경로 | 비고 |
|------|------|------|
| 새 배송 요청 | `/customer/new-delivery` | 결제 수단 선택 + "계좌/카드 연동" 링크 있음 |
| 계좌 연동 | `/customer/account-link` | 로그인 필수, 새 배송 요청으로 돌아가기 링크 있음 |
| 결제 페이지 | `/customer/delivery/[id]/pay` | 카드 선택 시 이동, 토스 일회성 결제 |

위 경로로 이동하는지 한 번씩 클릭해서 확인하면 됩니다.
